<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Midgarverse Home</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script type="importmap">
        {
          "imports": {
            "three": "https://unpkg.com/three/build/three.module.js",
            "OrbitControls":"https://unpkg.com/three/examples/jsm/controls/OrbitControls.js",
            "GLTFLoader":"https://unpkg.com/three/examples/jsm/loaders/GLTFLoader.js",
            "OutlineEffect":"https://unpkg.com/three/examples/jsm/effects/OutlineEffect.js"
          }
        }
    </script>
    <script type="module">
        import * as THREE from "three";
        import { OrbitControls } from "OrbitControls";
        import { GLTFLoader } from "GLTFLoader";
        import { OutlineEffect } from "OutlineEffect";
        const scene = new THREE.Scene();
        // const materialOR = new THREE.MeshBasicMaterial({ color: "green" });
        // scene.overrideMaterial = materialOR;

        const cam2Group = new THREE.Group();
        const cameraGroup = new THREE.Group()
        cam2Group.add(cameraGroup);
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        cameraGroup.add(camera);
        scene.add(cam2Group);

        const bal = new THREE.SphereGeometry(0.0625, 32, 16);
        const ball = new THREE.Mesh(bal, new THREE.MeshBasicMaterial({ color: 0xff0000 }));
        // scene.add(ball);

        const canvas = document.querySelector('canvas.webgl');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        const floating = document.querySelector('div.floating');

        const renderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;

        let lastKnownScr = 0;
        let ticking = false;

        const plight = new THREE.PointLight(0xffefdf, 1, 50, 0.05);
        plight.castShadow = true;
        plight.shadow.mapSize.width = 2048;
        plight.shadow.mapSize.height = 2048;
        plight.shadow.camera.near = 0.1;
        plight.shadow.camera.far = 40;
        plight.shadow.focus = 1
        plight.shadow.bias = -0.002;
        plight.position.set(0, 4, 0);

        scene.add(plight);

        scene.background = new THREE.Color(0x000000);
        scene.fog = new THREE.FogExp2(0x000000, 0.0025);

        const geometry = new THREE.TorusBufferGeometry(2, 0.06, 100, 100);

        const colors = new Uint8Array(10);

        const format = (renderer.capabilities.isWebGL2) ? THREE.RedFormat : THREE.LuminanceFormat;
        for (let c = 0; c <= colors.length; c++) {
            colors[c] = (c / colors.length) * 256;
        }
        const gradientMap = new THREE.DataTexture(colors, colors.length, 1, format);
        gradientMap.needsUpdate = true;

        const floorgeo = new THREE.PlaneBufferGeometry(200, 200, 1, 1);

        var texture = document.createElement('canvas');
        texture.width = texture.height = 500;
        var ctx = texture.getContext('2d');
        var x = 250,
            y = 250,
            innerRadius = 0,
            outerRadius = 200,
            radius = 200;
        var gradient = ctx.createRadialGradient(x, y, innerRadius, x, y, outerRadius);
        gradient.addColorStop(0, 'rgb(50,50,50)');
        gradient.addColorStop(0.5, 'black');
        ctx.fillStyle = gradient;
        ctx.fillRect(0, 0, 500, 1500);
        var texture = new THREE.Texture(texture);
        texture.needsUpdate = true;
        var cGradMaterial = new THREE.MeshStandardMaterial({
            map: texture,
            roughness: 1.0,
            metalness: 0.0,
        });


        const floor = new THREE.Mesh(floorgeo, cGradMaterial);
        floor.rotation.set(-0.5 * Math.PI, 0, 0)
        floor.position.set(0, 0, 0);
        floor.receiveShadow = true;
        scene.add(floor);

        const loader = new GLTFLoader();
        loader.load('models/combat.glb', function (gltf) {
            for (let i = 0; i < gltf.scene.children.length; i++) {
                const element = gltf.scene.children[i];
                element.castShadow = true;
                element.receiveShadow = true;
            }
            scene.add(gltf.scene);
            animate();
        });

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            render();
        }, false);

        const effect = new OutlineEffect(renderer, { "defaultThickness": 0.0005, "defaultColor": [0.25, 0.25, 0.25] });

        function animate() {

            requestAnimationFrame(animate);
            render();
        }
        const camPositionsX = [0, 0, -3.6, -3.6, -3.35, -3.35, -2, -2, -3.15, -3.15, 2, 2, 2.5, 2.5];
        const camPositionsY = [1.4, 1.4, 1.5, 1.5, 1.3, 1.3, 1.2, 1.2, 1.3, 1.3, 1.4, 1.4, 1.5, 1.5];
        const camPositionsZ = [0, 0, -3.6, -3.6, 2.25, 2.25, 2.9, 2.9, -1, -1, 1.9, 1.9, -2.5, -2.5];

        const scrollsY = [50, 50, 120, 120, 190, 190, 260, 260, 330, 330];

        const cursor = {}
        cursor.x = 0
        cursor.y = 0

        window.addEventListener('mousemove', (event) => {
            cursor.x = event.clientX / window.innerWidth - 0.5
            cursor.y = event.clientY / window.innerHeight - 0.5
        })

        function lerp(before, after, atPoint) {
            return before + (after - before) * atPoint;
        };

        const uniTime = 1;
        const table = document.getElementById('mainTable');
        table.style.position = "absolute";

        function render() {
            var time = uniTime * performance.now() * 0.001;
            var delta = performance.delta;

            // camera.position.set(0,2+1*Math.cos(0.025*time),7+3*Math.cos(0.025*time))

            var proportion = (camPositionsX.length) * window.scrollY / (12100 - window.innerHeight);
            var index = Math.floor(proportion);
            var position = proportion - index;
            var posX = lerp(camPositionsX[index], camPositionsX[(index + 1 == camPositionsX.length ? index : index + 1)], position);
            var posY = lerp(camPositionsY[index], camPositionsY[(index + 1 == camPositionsY.length ? index : index + 1)], position);
            var posZ = lerp(camPositionsZ[index], camPositionsZ[(index + 1 == camPositionsZ.length ? index : index + 1)], position);

            cam2Group.position.set(posX, posY, posZ)
            ball.position.set(posX, posY, posZ)

            cameraGroup.position.set(0, 0, 0)
            var camGPosX = 3 + 6.2832 * cursor.x + time*0.05
            var camGPosY = -1.25 - 3 * cursor.y
            // cam2Group.rotation.y += (camGPosX - cam2Group.rotation.y) * 0.1;
            // cam2Group.rotation.x = Math.min(10, cam2Group.rotation.x + (camGPosY - cam2Group.rotation.x) * 0.1);

            camera.position.set(3 * Math.cos(camGPosX), -camGPosY, 3 * Math.sin(camGPosX))
            camera.lookAt(posX, posY, posZ);

            var tabProportion = (camPositionsX.length) * window.scrollY / (12100 - window.innerHeight);
            var tabIndex = Math.floor(tabProportion);
            var tabPosition = tabProportion - tabIndex;
            table.style.left = 0 + 'vw';
            table.style.top = lerp(scrollsY[index], scrollsY[(index + 1 == scrollsY.length ? index : index + 1)], tabPosition); + 'vh';

            effect.render(scene, camera);
        }

        animate();
    </script>
    <style>
        body {
            margin: 0px;
            height: 11000px;
        }

        .floating {
            background-color: rgba(0, 0, 0, 0);
            text-align: center;
            overflow-y: scroll;
        }

        p {
            position: relative;
        }

        .div-table {
            display: table;
            width: 85%;
            margin-left: 7.5%;
            margin-right: 7.5%;
            overflow-y: scroll;
        }

        .div-table-row {
            display: table-row;
            width: auto;
            clear: both;
        }

        .div-table-col {
            float: left;
            display: table-column;
            width: 50%;
        }
    </style>
</head>

<body>

    <canvas class="webgl" style="position:fixed; top:0vh; left:0vw;"></canvas>

    <div id="scrollable" class="floating" style="margin-top:50vh;">
        <div class="div-table" id="mainTable">
            <div class="div-table-row" style="height:80vh;">
                <p>some text about this project here</p>
            </div>
            <div class="div-table-row" style="height:80vh;">
                <p>some text about this project here</p>
            </div>
            <div class="div-table-row" style="height:80vh;">
                <p>some text about this project here</p>
            </div>
            <div class="div-table-row" style="height:80vh;">
                <p>some text about this project here</p>
            </div>
            <div class="div-table-row" style="height:80vh;">
                <div class="div-table" id="subTable">
                    <div class="div-table-row">
                        <div class="div-table-col">
                            <p>some text about this project here</p>
                        </div>
                        <div class="div-table-col">
                            <p>some text about this project here</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="div-table-row" style="height:80vh;">
                <p>some text about this project here</p>
            </div>
            <div class="div-table-row" style="height:80vh;">
                <p>some text about this project here</p>
            </div>
            <div class="div-table-row" style="height:80vh;">
                <div class="div-table" id="subTable">
                    <div class="div-table-row">
                        <div class="div-table-col">
                            <p>some text about this project here</p>
                        </div>
                        <div class="div-table-col">
                            <p>some text about this project here</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="div-table-row" style="height:80vh;">
                <p>some text about this project here</p>
            </div>
        </div>

    </div>

</body>

</html>